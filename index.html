<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mario Drunk World</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <style>
        :root {
            --mario-red: #E52521; --mario-blue: #049CD8;
            --mario-yellow: #FBD000; --mario-green: #43B047;
            --sky-blue: #73D2FF; --gold: #FFD700; --silver: #C0C0C0; --bronze: #CD7F32;
            --white: #FFFFFF; --save-btn: #9c27b0;
        }
        body {
            font-family: 'Fredoka One', cursive; 
            background: var(--sky-blue) url('Fondo_MarioDrunk.png') no-repeat center center fixed;
            background-size: cover;
            color: #333; margin: 0; padding: 10px; overflow-x: hidden;
        }
        .container {
            max-width: 600px; margin: auto; background: rgba(255, 255, 255, 0.9);
            padding: 20px; border-radius: 30px; border: 8px solid var(--mario-red);
            text-align: center; min-height: 90vh; box-shadow: 0 10px 0 rgba(0,0,0,0.1);
        }
        .hidden { display: none; }
        .logo { width: 100%; max-width: 450px; margin-bottom: 10px; cursor: pointer; filter: drop-shadow(2px 4px 0px rgba(0,0,0,0.2)); }
        
        h1, h2 { color: var(--mario-red); text-shadow: 2px 2px var(--mario-yellow); -webkit-text-stroke: 1px #8a1512; }
        
        /* Botones Estilo Nintendo */
        button {
            font-family: 'Fredoka One'; padding: 15px 20px; border: none;
            border-radius: 20px; cursor: pointer; transition: transform 0.1s, box-shadow 0.1s;
            box-shadow: 0 5px 0 rgba(0,0,0,0.2); margin: 5px;
        }
        button:active { transform: translateY(3px); box-shadow: 0 2px 0 rgba(0,0,0,0.2); }
        
        .btn-main { background: var(--mario-green); color: white; font-size: 1.2rem; width: 100%; }
        .btn-nav { background: var(--mario-blue); color: white; flex: 1; }
        .btn-archive { background: #ff7f00; color: white; width: 100%; font-size: 1.1rem; }
        .btn-save { background: var(--save-btn); color: white; width: 100%; font-size: 1rem; margin-top: 10px; }

        .tournament-title { background: var(--mario-yellow); color: var(--mario-red); padding: 10px; border-radius: 15px; border: 3px solid var(--mario-red); margin-bottom: 20px; }

        /* Tarjetas de Juego */
        .group-card { background: white; padding: 15px; border-radius: 25px; border: 4px solid var(--mario-blue); margin: 20px 0; box-shadow: inset 0 0 10px rgba(0,0,0,0.05); }
        .gp-title { color: var(--mario-blue); font-size: 1.6rem; margin-bottom: 15px; background: #e1f5ff; border-radius: 15px; padding: 5px; }
        
        .player-row { background: #f0f0f0; padding: 15px; border-radius: 20px; margin-bottom: 12px; border: 2px solid #ddd; }
        .race-inputs { display: flex; gap: 8px; margin-top: 10px; justify-content: center; }
        .pts-input { 
            width: 45px; height: 40px; border-radius: 12px; border: 3px solid var(--mario-blue); 
            text-align: center; font-family: 'Fredoka One'; background: white; color: var(--mario-red); font-size: 1.1rem;
        }

        /* Podio y Copas */
        .podium-box { margin: 20px 0; padding: 25px; border-radius: 25px; border: 5px solid; position: relative; }
        .gold-box { border-color: var(--gold); background: #fffde7; }
        .silver-box { border-color: var(--silver); background: #f5f5f5; }
        .bronze-box { border-color: var(--bronze); background: #fff3e0; }
        .cup-icon { font-size: 2.5rem; display: block; margin-bottom: 10px; }

        /* Tabla de Clasificaci√≥n */
        table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        td { padding: 15px; background: white; border: 3px solid #eee; border-radius: 15px; font-size: 1.1rem; }
        .gold-row td { background: #fff9c4; border-color: var(--gold); color: #827717; }
        .silver-row td { background: #f0f0f0; border-color: var(--silver); color: #616161; }
        .bronze-row td { background: #efebe9; border-color: var(--bronze); color: #4e342e; }

        input[type="text"] { 
            padding: 15px; border-radius: 15px; border: 3px solid var(--mario-blue); 
            font-family: 'Fredoka One'; width: 100%; box-sizing: border-box; font-size: 1rem;
        }
        select { padding: 10px; border-radius: 15px; border: 3px solid var(--mario-green); font-family: 'Fredoka One'; width: 100%; }
        
        .status-badge { display: inline-block; padding: 5px 10px; border-radius: 10px; font-size: 0.8rem; margin-bottom: 5px; }
        .status-active { background: #e3f2fd; color: var(--mario-blue); border: 2px solid var(--mario-blue); }
        .status-finished { background: #fff8e1; color: #ff8f00; border: 2px solid var(--gold); }
    </style>
</head>
<body>

<div class="container">
    <img src="https://raw.githubusercontent.com/SalvaBG18/salvabg18.github.io/main/MarioDrunk_Logo.png" class="logo" onclick="location.reload()">
    <div id="active-tournament-name" class="tournament-title hidden"></div>

    <div id="view-home">
        <h1>üçÑ MEN√ö PRINCIPAL üçÑ</h1>
        <div style="margin-top:30px;">
            <input type="text" id="tournament-input" placeholder="Nombre del Torneo..." style="text-align: center;">
            <button class="btn-main" onclick="initTournament()">üöÄ INICIAR COMPETICI√ìN</button>
            <button class="btn-archive" onclick="openArchive()">üìö VER ARCHIVO</button>
        </div>
    </div>

    <div id="view-archive" class="hidden">
        <h2>üìú HISTORIAL DE COPAS</h2>
        <div id="archive-list" style="margin: 20px 0;"></div>
        <button class="btn-nav" onclick="showView('view-home')" style="width:100%;">üè† VOLVER AL MEN√ö</button>
    </div>

    <div id="view-setup" class="hidden">
        <h2>üë• SELECCI√ìN DE PILOTOS üë•</h2>
        <div id="setup-list"></div>
        <button onclick="addParticipantRow()" style="background:var(--mario-blue); color:white; margin-top:10px;">‚ûï A√ëADIR PILOTO</button>
        <button class="btn-main" onclick="startBrackets()">üé≤ SORTEAR GRUPOS</button>
        <button class="btn-save" onclick="saveGame(false)">üíæ GUARDAR PROGRESO</button>
    </div>

    <div id="view-brackets" class="hidden">
        <h2 id="round-header">üèéÔ∏è RONDA 1</h2>
        <div id="group-display"></div>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button id="prevBtn" class="btn-nav" onclick="changeGroup(-1)">üëà ANTERIOR</button>
            <button id="nextBtn" class="btn-nav" onclick="changeGroup(1)">SIGUIENTE üëâ</button>
        </div>
        <button class="btn-save" onclick="saveGame(false)">üíæ GUARDAR PROGRESO</button>
        <button id="finishBtn" class="btn-main hidden" onclick="renderRankingView()" style="margin-top:15px;">üèÅ FINALIZAR GRAN PRIX</button>
    </div>

    <div id="view-ranking" class="hidden">
        <h2>üìä RESULTADOS ACTUALES üìä</h2>
        <table><tbody id="ranking-body"></tbody></table>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-nav" id="back-to-brackets" onclick="showView('view-brackets')">‚úèÔ∏è CORREGIR</button>
            <button class="btn-nav" style="background:var(--mario-green)" onclick="showView('view-podium')">üåü CEREMONIA FINAL</button>
        </div>
        <button class="btn-save" onclick="saveGame(false)">üíæ GUARDAR PROGRESO</button>
    </div>

    <div id="view-podium" class="hidden">
        <h2>üèÜ CEREMONIA DE PREMIOS üèÜ</h2>
        <div class="podium-box gold-box"><span class="cup-icon">üëë</span><small>CAMPE√ìN COPA ORO</small><br><input type="text" id="win-gold" class="pts-input" style="width:90%; border-color:var(--gold);"></div>
        <div class="podium-box silver-box"><span class="cup-icon">ü•à</span><small>CAMPE√ìN COPA PLATA</small><br><input type="text" id="win-silver" class="pts-input" style="width:90%; border-color:var(--silver);"></div>
        <div class="podium-box bronze-box"><span class="cup-icon">ü•â</span><small>CAMPE√ìN COPA BRONCE</small><br><input type="text" id="win-bronze" class="pts-input" style="width:90%; border-color:var(--bronze);"></div>
        
        <button class="btn-main" onclick="saveGame(true)">üíæ GUARDAR Y FINALIZAR</button>
    </div>
</div>

<script>
    // Variables globales
    let players = [], allGroups = [], currentGroupIdx = 0, currentTName = "", currentTId = null;
    const characters = ["Mario üî¥", "Luigi üü¢", "Wario üü°", "Waluigi üü£", "Peach üíñ", "Daisy üçë", "Yoshi ü¶ñ", "Toad üçÑ", "Donkey Kong ü¶ç", "Bowser üî•‚Äã", "Bowsy üî•üçº‚Äã", "Estela üå†", "Koopa üê¢", "Huesitos ü¶¥‚Äã", "Shy Guy üé≠", "Vaca üêÑ‚Äã", "Pingu üêß‚Äã", "Topo Monty üòé"];

    function showView(v) {
        document.querySelectorAll('.container > div').forEach(d => d.classList.add('hidden'));
        document.getElementById(v).classList.remove('hidden');
        window.scrollTo(0,0);
    }

    // Iniciar nuevo torneo
    function initTournament() {
        currentTName = document.getElementById('tournament-input').value || "TORNEO " + new Date().toLocaleDateString();
        currentTId = Date.now(); // ID √∫nico para esta sesi√≥n
        players = []; // Reiniciar
        allGroups = [];
        
        // Limpiar inputs anteriores
        document.getElementById('setup-list').innerHTML = '';
        for(let i=0; i<12; i++) addParticipantRow();

        updateHeader();
        showView('view-setup');
    }

    function updateHeader() {
        const header = document.getElementById('active-tournament-name');
        header.innerText = "‚≠ê " + currentTName + " ‚≠ê";
        header.classList.remove('hidden');
    }

    function addParticipantRow(nameVal = '', charVal = '') {
        const div = document.createElement('div');
        div.className = "player-row";
        
        // Generar opciones del select, marcando la seleccionada si existe
        let opts = characters.map(c => `<option ${c === charVal ? 'selected' : ''}>${c}</option>`).join('');
        
        div.innerHTML = `<input type="text" placeholder="Piloto" class="p-name" value="${nameVal}" style="width:100%; margin-bottom:10px;"> 
            <select class="p-char">${opts}</select>`;
        document.getElementById('setup-list').appendChild(div);
    }

    function startBrackets() {
        // Leer datos del DOM
        const names = document.querySelectorAll('.p-name');
        const pChars = document.querySelectorAll('.p-char');
        players = [];
        
        names.forEach((n, i) => { 
            if(n.value.trim()) {
                players.push({ 
                    id: i, 
                    name: n.value, 
                    char: pChars[i].value, 
                    scores: Array(8).fill(0), 
                    total: 0 
                }); 
            }
        });

        if(players.length < 12) return alert("¬°Necesitas 12 pilotos para los 6 Gran Prix!");
        
        // Generar grupos aleatorios
        const r1 = chunkArray([...players].sort(() => 0.5 - Math.random()), 4).slice(0,3);
        const r2 = chunkArray([...players].sort(() => 0.5 - Math.random()), 4).slice(0,3);
        allGroups = [...r1.map((g,i)=>({r:1, n:i+1, p:g})), ...r2.map((g,i)=>({r:2, n:i+4, p:g}))];
        currentGroupIdx = 0;
        
        renderGroup();
        showView('view-brackets');
        saveGame(false); // Guardado autom√°tico al empezar
    }

    function renderGroup() {
        if(!allGroups || allGroups.length === 0) return;
        const data = allGroups[currentGroupIdx];
        document.getElementById('round-header').innerText = `üèéÔ∏è RONDA ${data.r}`;
        let html = `<div class="group-card"><div class="gp-title">üèÅ GRAN PRIX ${data.n}</div>`;
        data.p.forEach(p => {
            // Buscar el objeto jugador real para obtener sus puntos actualizados
            const realPlayer = players.find(x => x.id === p.id) || p;
            const start = (data.r - 1) * 4;
            
            html += `<div class="player-row"><strong>${realPlayer.name}</strong> <small>(${realPlayer.char})</small><div class="race-inputs">
                ${[0,1,2,3].map(c => `<input type="number" class="pts-input" value="${realPlayer.scores[start+c]||''}" onchange="updSc(${realPlayer.id},${start+c},this.value)">`).join('')}
            </div></div>`;
        });
        document.getElementById('group-display').innerHTML = html + `</div>`;
        
        // Control de botones
        document.getElementById('prevBtn').disabled = currentGroupIdx === 0;
        document.getElementById('nextBtn').disabled = currentGroupIdx === allGroups.length - 1;
        document.getElementById('prevBtn').style.opacity = currentGroupIdx === 0 ? 0.5 : 1;
        document.getElementById('nextBtn').style.opacity = currentGroupIdx === allGroups.length - 1 ? 0.5 : 1;

        document.getElementById('finishBtn').classList.toggle('hidden', currentGroupIdx !== 5);
        document.getElementById('group-display').classList.add('fade-in');
    }

    function updSc(id, idx, val) { 
        const p = players.find(x => x.id === id); 
        p.scores[idx] = parseInt(val) || 0; 
        p.total = p.scores.reduce((a, b) => a + b, 0); 
    }

    function changeGroup(d) { 
        if((currentGroupIdx + d) < 0 || (currentGroupIdx + d) >= allGroups.length) return;
        currentGroupIdx += d; 
        renderGroup(); 
    }

    function renderRankingView() {
        const body = document.getElementById('ranking-body'); body.innerHTML = '';
        const sorted = [...players].sort((a,b) => b.total - a.total);
        sorted.forEach((p, i) => {
            let cls = i < 4 ? 'gold-row' : (i < 8 ? 'silver-row' : (i < 12 ? 'bronze-row' : ''));
            let icon = i === 0 ? 'üèÜ' : (i < 4 ? '‚≠ê' : 'üèéÔ∏è');
            body.innerHTML += `<tr class="${cls}"><td>${icon} ${i+1}¬∫</td><td>${p.name}</td><td>${p.total} pts</td></tr>`;
        });
        showView('view-ranking');
    }

    // --- NUEVO SISTEMA DE GUARDADO ---
    
    function saveGame(isFinished) {
        // Recoger datos actuales del podio si estamos en esa vista
        const winners = {
            g: document.getElementById('win-gold').value,
            s: document.getElementById('win-silver').value,
            b: document.getElementById('win-bronze').value
        };

        const saveData = {
            id: currentTId,
            name: currentTName,
            date: new Date().toLocaleString(),
            finished: isFinished,
            // Guardamos el estado completo de los datos
            players: players,
            groups: allGroups,
            groupIdx: currentGroupIdx,
            winners: winners
        };

        let arch = JSON.parse(localStorage.getItem('marioArchive')) || [];
        
        // Buscar si ya existe este torneo por ID para actualizarlo, si no, a√±adirlo
        const existingIdx = arch.findIndex(t => t.id === currentTId);
        if (existingIdx >= 0) {
            arch[existingIdx] = saveData;
        } else {
            arch.push(saveData);
        }

        localStorage.setItem('marioArchive', JSON.stringify(arch));
        
        if(isFinished) {
            alert("¬°Torneo Finalizado y Guardado con √âxito! üèÜ");
            location.reload();
        } else {
            alert("‚úÖ Progreso guardado correctamente.");
        }
    }

    function openArchive() {
        const list = document.getElementById('archive-list');
        list.innerHTML = '';
        const arch = JSON.parse(localStorage.getItem('marioArchive')) || [];
        
        if(arch.length === 0) list.innerHTML = "<p>üçå No hay torneos guardados a√∫n.</p>";
        
        // Ordenar: los m√°s recientes primero
        arch.reverse().forEach((t, i) => {
            // Determinar si es antiguo (solo HTML) o nuevo (Objeto de datos)
            const isLegacy = !t.id; 
            const isFinished = t.finished === true;
            
            let statusBadge = isFinished 
                ? `<span class="status-badge status-finished">üèÜ FINALIZADO</span>` 
                : `<span class="status-badge status-active">‚ñ∂Ô∏è EN CURSO</span>`;

            // √çndice real en el array original (porque hemos invertido para mostrar)
            const realIndex = arch.length - 1 - i;

            list.innerHTML += `
            <div class="archive-item" style="background:white; border:2px solid var(--mario-blue); border-radius:15px; padding:15px; margin-bottom:10px; text-align:left;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        ${statusBadge}<br>
                        <strong style="color:var(--mario-red); font-size:1.1rem;">${t.name}</strong><br>
                        <small style="color:#666">üìÖ ${t.date || 'Desconocida'}</small>
                    </div>
                    <div>
                        <button onclick="loadTournament(${realIndex})" style="background:${isFinished ? '#ff9800' : 'var(--mario-green)'}; color:white; padding:10px 15px; font-size:0.9rem;">
                            ${isFinished ? 'VER' : 'REANUDAR'}
                        </button>
                        <button onclick="deleteTournament(${realIndex})" style="background:#e52521; color:white; padding:10px;">üóëÔ∏è</button>
                    </div>
                </div>
            </div>`;
        });
        showView('view-archive');
    }

    function loadTournament(idx) {
        const arch = JSON.parse(localStorage.getItem('marioArchive'));
        const t = arch[idx];
        
        // Restaurar IDs y Nombres
        currentTId = t.id || Date.now();
        currentTName = t.name;
        updateHeader();

        // Restaurar estado de jugadores y grupos
        // Si es un archivo antiguo que solo guardaba HTML (compatibilidad)
        if (!t.players) {
            alert("Este es un archivo antiguo. Solo se puede ver el resultado final.");
            document.getElementById('ranking-body').innerHTML = t.ranking;
            document.getElementById('win-gold').value = t.winners?.g || '';
            document.getElementById('win-silver').value = t.winners?.s || '';
            document.getElementById('win-bronze').value = t.winners?.b || '';
            document.getElementById('back-to-brackets').classList.add('hidden');
            showView('view-ranking');
            return;
        }

        // Cargar datos completos
        players = t.players;
        allGroups = t.groups;
        currentGroupIdx = t.groupIdx || 0;

        // Rellenar inputs de podio
        if(t.winners) {
            document.getElementById('win-gold').value = t.winners.g;
            document.getElementById('win-silver').value = t.winners.s;
            document.getElementById('win-bronze').value = t.winners.b;
        }

        if (t.finished) {
            // Si est√° terminado, vamos directo al podio o ranking
            renderRankingView();
            // Mostramos bot√≥n de podio
            document.getElementById('back-to-brackets').classList.remove('hidden');
        } else {
            // Si est√° en curso, determinar d√≥nde ir
            if (allGroups.length > 0) {
                renderGroup();
                showView('view-brackets');
            } else {
                // Si guardaron en el setup sin sortear grupos
                document.getElementById('setup-list').innerHTML = '';
                players.forEach(p => addParticipantRow(p.name, p.char));
                // Rellenar hasta 12 si faltan
                for(let k=players.length; k<12; k++) addParticipantRow();
                showView('view-setup');
            }
        }
    }

    function deleteTournament(idx) {
        if(confirm("¬øSeguro que quieres borrar este torneo?")) {
            let arch = JSON.parse(localStorage.getItem('marioArchive')) || [];
            arch.splice(idx, 1);
            localStorage.setItem('marioArchive', JSON.stringify(arch));
            openArchive();
        }
    }

    function chunkArray(a, s) { let r = []; for(let i=0; i<a.length; i+=s) r.push(a.slice(i, i+s)); return r; }
    
    // Inicializar setup vac√≠o al cargar
    for(let i=0; i<12; i++) addParticipantRow();
</script>
</body>
</html>
