<script>
    // --- VARIABLES GLOBALES ---
    let players = [], allGroups = [], currentGroupIdx = 0, currentTName = "";
    // Variable para saber en qu√© vista estamos y restaurarla
    let currentViewId = "view-home"; 
    const characters = ["Mario üî¥", "Luigi üü¢", "Wario üü°", "Waluigi üü£", "Peach üíñ", "Daisy üçë", "Yoshi ü¶ñ", "Toad üçÑ", "Donkey Kong ü¶ç", "Bowser üî•‚Äã", "Bowsy üî•üçº‚Äã", "Rosalina üå†", "Koopa üê¢", "Huesitos ü¶¥‚Äã", "Shy Guy üé≠", "Vaca üêÑ‚Äã", "Pingu üêß‚Äã", "Topo Monty üòé"];

    // --- AL CARGAR LA P√ÅGINA ---
    window.onload = function() {
        checkRestore(); // Comprobamos si hay una partida a medias
    };

    // --- GESTI√ìN DE VISTAS ---
    function showView(v) {
        document.querySelectorAll('.container > div').forEach(d => d.classList.add('hidden'));
        document.getElementById(v).classList.remove('hidden');
        window.scrollTo(0,0);
        
        currentViewId = v; // Guardamos la vista actual
        if(v !== 'view-home') autoSave(); // Guardamos estado si no es el home
    }

    // --- SISTEMA DE AUTOGUARDADO (LOCAL STORAGE) ---
    function autoSave() {
        // Solo guardamos si hay un torneo en curso (tenemos nombre o jugadores)
        if (!currentTName && players.length === 0) return;

        const gameState = {
            tName: currentTName,
            pl: players,
            gr: allGroups,
            idx: currentGroupIdx,
            view: currentViewId,
            setupHTML: document.getElementById('setup-list').innerHTML // Guardamos visualmente la lista de setup
        };
        localStorage.setItem('marioTempSave', JSON.stringify(gameState));
    }

    function checkRestore() {
        const saved = JSON.parse(localStorage.getItem('marioTempSave'));
        if (saved && saved.view !== 'view-home' && saved.view !== 'view-podium') {
            // Si hay datos guardados y no estamos en el inicio ni habiamos terminado
            if(confirm("‚ö†Ô∏è Se ha detectado un torneo anterior sin finalizar (" + saved.tName + "). \n¬øQuieres restaurarlo?")) {
                restoreGame(saved);
            } else {
                localStorage.removeItem('marioTempSave'); // Borrar si el usuario dice NO
            }
        }
    }

    function restoreGame(data) {
        currentTName = data.tName;
        players = data.pl;
        allGroups = data.gr;
        currentGroupIdx = data.idx;
        
        // Restaurar cabecera
        const header = document.getElementById('active-tournament-name');
        header.innerText = "‚≠ê " + currentTName + " ‚≠ê";
        header.classList.remove('hidden');

        // Restaurar lista de setup si estamos en esa fase
        if(data.view === 'view-setup') {
            document.getElementById('setup-list').innerHTML = data.setupHTML;
            // Re-asignar valores a los inputs (el HTML innerHTML no guarda valores de inputs)
            const names = document.querySelectorAll('.p-name');
            const chars = document.querySelectorAll('.p-char');
            // Intentamos recuperar nombres si existen en players
            if(players.length > 0) {
                 players.forEach((p, i) => {
                     if(names[i]) names[i].value = p.name;
                     if(chars[i]) chars[i].value = p.char;
                 });
            }
        }

        // Si ya estabamos en brackets, renderizamos
        if(data.view === 'view-brackets') {
            renderGroup();
        }
        
        // Si estabamos en ranking
        if(data.view === 'view-ranking') {
            renderRankingView();
        }

        showView(data.view);
    }

    function clearTempSave() {
        localStorage.removeItem('marioTempSave');
        currentTName = "";
        players = [];
        allGroups = [];
        currentGroupIdx = 0;
    }

    // --- FUNCIONES DEL JUEGO ---

    function initTournament() {
        // Limpiamos cualquier guardado temporal anterior al empezar uno nuevo de cero
        clearTempSave();
        
        currentTName = document.getElementById('tournament-input').value || "TORNEO " + new Date().toLocaleDateString();
        const header = document.getElementById('active-tournament-name');
        header.innerText = "‚≠ê " + currentTName + " ‚≠ê";
        header.classList.remove('hidden');
        
        // Limpiar lista de setup anterior
        document.getElementById('setup-list').innerHTML = '';
        for(let i=0; i<12; i++) addParticipantRow();

        showView('view-setup');
    }

    function addParticipantRow() {
        const div = document.createElement('div');
        div.className = "player-row";
        div.innerHTML = `<input type="text" placeholder="Piloto" class="p-name" style="width:100%; margin-bottom:10px;" onchange="autoSave()"> 
            <select class="p-char" onchange="autoSave()">${characters.map(c=>`<option>${c}</option>`).join('')}</select>`;
        document.getElementById('setup-list').appendChild(div);
    }

    function startBrackets() {
        const names = document.querySelectorAll('.p-name');
        const pChars = document.querySelectorAll('.p-char');
        players = [];
        
        // Capturar datos
        let validCount = 0;
        names.forEach((n, i) => { 
            if(n.value.trim()) {
                players.push({ id: i, name: n.value, char: pChars[i].value, scores: Array(8).fill(0), total: 0 }); 
                validCount++;
            }
        });

        if(players.length < 12) return alert("¬°Necesitas 12 pilotos para los 6 Gran Prix!");
        
        const r1 = chunkArray([...players].sort(() => 0.5 - Math.random()), 4).slice(0,3);
        const r2 = chunkArray([...players].sort(() => 0.5 - Math.random()), 4).slice(0,3);
        allGroups = [...r1.map((g,i)=>({r:1, n:i+1, p:g})), ...r2.map((g,i)=>({r:2, n:i+4, p:g}))];
        currentGroupIdx = 0;
        
        renderGroup();
        showView('view-brackets');
    }

    function renderGroup() {
        const data = allGroups[currentGroupIdx];
        document.getElementById('round-header').innerText = `üèéÔ∏è RONDA ${data.r}`;
        let html = `<div class="group-card"><div class="gp-title">üèÅ GRAN PRIX ${data.n}</div>`;
        data.p.forEach(p => {
            const start = (data.r - 1) * 4;
            // NOTA: A√±adido oninput="autoSave()" para guardar mientras escribes
            html += `<div class="player-row"><strong>${p.name}</strong> <small>(${p.char})</small><div class="race-inputs">
                ${[0,1,2,3].map(c => `<input type="number" class="pts-input" value="${p.scores[start+c]||''}" onchange="updSc(${p.id},${start+c},this.value)">`).join('')}
            </div></div>`;
        });
        document.getElementById('group-display').innerHTML = html + `</div>`;
        document.getElementById('finishBtn').classList.toggle('hidden', currentGroupIdx !== 5);
        document.getElementById('group-display').classList.add('fade-in');
    }

    function updSc(id, idx, val) { 
        const p = players.find(x => x.id === id); 
        p.scores[idx] = parseInt(val) || 0; 
        p.total = p.scores.reduce((a, b) => a + b, 0); 
        autoSave(); // Guardar cada vez que se actualiza un punto
    }

    function changeGroup(d) { 
        currentGroupIdx += d; 
        renderGroup(); 
        autoSave(); // Guardar al cambiar de grupo
    }

    function renderRankingView() {
        const body = document.getElementById('ranking-body'); body.innerHTML = '';
        const sorted = [...players].sort((a,b) => b.total - a.total);
        sorted.forEach((p, i) => {
            let cls = i < 4 ? 'gold-row' : (i < 8 ? 'silver-row' : (i < 12 ? 'bronze-row' : ''));
            let icon = i === 0 ? 'üèÜ' : (i < 4 ? '‚≠ê' : 'üèéÔ∏è');
            body.innerHTML += `<tr class="${cls}"><td>${icon} ${i+1}¬∫</td><td>${p.name}</td><td>${p.total} pts</td></tr>`;
        });
        showView('view-ranking');
    }

    function saveToArchive() {
        const entry = {
            name: currentTName,
            ranking: document.getElementById('ranking-body').innerHTML,
            winners: { g: document.getElementById('win-gold').value, s: document.getElementById('win-silver').value, b: document.getElementById('win-bronze').value }
        };
        let arch = JSON.parse(localStorage.getItem('marioArchive')) || [];
        arch.push(entry);
        localStorage.setItem('marioArchive', JSON.stringify(arch));
        
        // ¬°IMPORTANTE! Al finalizar y archivar, borramos el guardado temporal
        clearTempSave();
        
        location.reload();
    }

    function openArchive() {
        const list = document.getElementById('archive-list');
        list.innerHTML = '';
        const arch = JSON.parse(localStorage.getItem('marioArchive')) || [];
        if(arch.length === 0) list.innerHTML = "<p>üçå No hay torneos guardados a√∫n.</p>";
        arch.forEach((t, i) => {
            list.innerHTML += `<div class="archive-item" style="margin-bottom:10px; padding:10px; background:white; border:2px solid var(--mario-blue); border-radius:10px;">
                <span style="color:var(--mario-red); font-weight:bold;">üèÅ ${t.name}</span>
                <button onclick="viewHistory(${i})" style="float:right; background:var(--mario-blue); color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">ABRIR</button>
                <div style="clear:both;"></div>
            </div>`;
        });
        showView('view-archive');
    }

    function viewHistory(idx) {
        const t = JSON.parse(localStorage.getItem('marioArchive'))[idx];
        document.getElementById('active-tournament-name').innerText = "üìñ ARCHIVO: " + t.name;
        document.getElementById('active-tournament-name').classList.remove('hidden');
        document.getElementById('ranking-body').innerHTML = t.ranking;
        document.getElementById('win-gold').value = t.winners.g;
        document.getElementById('win-silver').value = t.winners.s;
        document.getElementById('win-bronze').value = t.winners.b;
        document.getElementById('back-to-brackets').classList.add('hidden');
        showView('view-ranking');
    }

    function chunkArray(a, s) { let r = []; for(let i=0; i<a.length; i+=s) r.push(a.slice(i, i+s)); return r; }
</script>
